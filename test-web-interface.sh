#!/bin/bash

# Script de test pour l'interface web DoriaV2
# V√©rifie toutes les fonctionnalit√©s et endpoints

set -e

# Configuration
API_BASE="http://localhost:8081/api"
WEB_BASE="http://localhost:8081"
TIMEOUT=10

# Couleurs
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m'

# Fonctions d'affichage
log_info() { echo -e "${BLUE}‚ÑπÔ∏è  $1${NC}"; }
log_success() { echo -e "${GREEN}‚úÖ $1${NC}"; }
log_warning() { echo -e "${YELLOW}‚ö†Ô∏è  $1${NC}"; }
log_error() { echo -e "${RED}‚ùå $1${NC}"; }
log_test() { echo -e "${CYAN}üß™ Test: $1${NC}"; }

# Compteurs
TESTS_TOTAL=0
TESTS_PASSED=0
TESTS_FAILED=0

# Fonction de test g√©n√©rique
run_test() {
    local test_name="$1"
    local test_command="$2"
    local expected_result="$3"
    
    TESTS_TOTAL=$((TESTS_TOTAL + 1))
    log_test "$test_name"
    
    if eval "$test_command" >/dev/null 2>&1; then
        log_success "$test_name - R√âUSSI"
        TESTS_PASSED=$((TESTS_PASSED + 1))
        return 0
    else
        log_error "$test_name - √âCHEC"
        TESTS_FAILED=$((TESTS_FAILED + 1))
        return 1
    fi
}

# Test de connectivit√© HTTP
test_http_get() {
    local url="$1"
    local description="$2"
    
    run_test "GET $description" "curl -s --max-time $TIMEOUT '$url' | grep -q 'success\\|html\\|DoriaV2'" "200"
}

# Test de POST
test_http_post() {
    local url="$1"
    local description="$2"
    local data="$3"
    
    run_test "POST $description" "curl -s --max-time $TIMEOUT -X POST '$url' -H 'Content-Type: application/json' -d '$data'" "200"
}

# En-t√™te
echo -e "\n${PURPLE}üß™ TESTS INTERFACE WEB DORIAE V2${NC}"
echo -e "${PURPLE}=================================${NC}\n"

# V√©rification pr√©liminaire
log_info "V√©rification de la disponibilit√© du serveur..."

if ! curl -s --max-time 5 "$WEB_BASE" >/dev/null 2>&1; then
    log_error "Le serveur web n'est pas accessible sur $WEB_BASE"
    log_info "Veuillez d√©marrer l'interface web avec: ./start-web-interface.sh"
    exit 1
fi

log_success "Serveur web accessible"

# Tests de l'interface web
echo -e "\n${CYAN}üåê Tests Interface Web${NC}"
echo -e "${CYAN}=====================${NC}"

test_http_get "$WEB_BASE" "Page principale"
test_http_get "$WEB_BASE/styles.css" "Fichier CSS"
test_http_get "$WEB_BASE/script.js" "Fichier JavaScript"

# Tests de l'API
echo -e "\n${CYAN}üîå Tests API REST${NC}"
echo -e "${CYAN}=================${NC}"

test_http_get "$API_BASE/status" "API Statut syst√®me"

# Tests des endpoints de contr√¥le (simulation)
log_test "API Contr√¥le Asterisk (simulation)"
for action in start stop restart status; do
    if curl -s --max-time $TIMEOUT -X POST "$API_BASE/control/$action" >/dev/null 2>&1; then
        log_success "POST /api/control/$action - R√âUSSI"
        TESTS_PASSED=$((TESTS_PASSED + 1))
    else
        log_warning "POST /api/control/$action - Mode simulation"
    fi
    TESTS_TOTAL=$((TESTS_TOTAL + 1))
done

# Tests des logs
log_test "API Journaux"
for log_type in asterisk docker; do
    if curl -s --max-time $TIMEOUT "$API_BASE/logs/$log_type" >/dev/null 2>&1; then
        log_success "GET /api/logs/$log_type - R√âUSSI"
        TESTS_PASSED=$((TESTS_PASSED + 1))
    else
        log_warning "GET /api/logs/$log_type - Mode simulation"
    fi
    TESTS_TOTAL=$((TESTS_TOTAL + 1))
done

# Tests des commandes Docker
log_test "API Docker (simulation)"
for action in up down restart ps; do
    if curl -s --max-time $TIMEOUT -X POST "$API_BASE/docker/$action" >/dev/null 2>&1; then
        log_success "POST /api/docker/$action - R√âUSSI"
        TESTS_PASSED=$((TESTS_PASSED + 1))
    else
        log_warning "POST /api/docker/$action - Mode simulation"
    fi
    TESTS_TOTAL=$((TESTS_TOTAL + 1))
done

# Tests de fonctionnalit√©s JavaScript
echo -e "\n${CYAN}‚ö° Tests Fonctionnalit√©s JavaScript${NC}"
echo -e "${CYAN}====================================${NC}"

# Test de la structure HTML
log_test "Structure HTML - Onglets navigation"
if curl -s "$WEB_BASE" | grep -q "dashboard-tab\\|extensions-tab\\|system-tab\\|logs-tab"; then
    log_success "Navigation par onglets - R√âUSSI"
    TESTS_PASSED=$((TESTS_PASSED + 1))
else
    log_error "Navigation par onglets - √âCHEC"
    TESTS_FAILED=$((TESTS_FAILED + 1))
fi
TESTS_TOTAL=$((TESTS_TOTAL + 1))

# Test de la pr√©sence des √©l√©ments cl√©s
log_test "√âl√©ments interface - Extension osmo"
if curl -s "$WEB_BASE" | grep -q "osmo\\|1000\\|osmoosmo"; then
    log_success "Configuration extension osmo - R√âUSSI"
    TESTS_PASSED=$((TESTS_PASSED + 1))
else
    log_error "Configuration extension osmo - √âCHEC"
    TESTS_FAILED=$((TESTS_FAILED + 1))
fi
TESTS_TOTAL=$((TESTS_TOTAL + 1))

# Test des num√©ros de test
log_test "Num√©ros de test disponibles"
if curl -s "$WEB_BASE" | grep -q "\\*43\\|\\*97\\|123"; then
    log_success "Num√©ros de test pr√©sents - R√âUSSI"
    TESTS_PASSED=$((TESTS_PASSED + 1))
else
    log_error "Num√©ros de test pr√©sents - √âCHEC"
    TESTS_FAILED=$((TESTS_FAILED + 1))
fi
TESTS_TOTAL=$((TESTS_TOTAL + 1))

# Test du responsive design
echo -e "\n${CYAN}üì± Tests Design Responsive${NC}"
echo -e "${CYAN}============================${NC}"

log_test "CSS Bootstrap et responsivit√©"
if curl -s "$WEB_BASE/styles.css" | grep -q "responsive\\|mobile\\|@media"; then
    log_success "CSS responsive - R√âUSSI"
    TESTS_PASSED=$((TESTS_PASSED + 1))
else
    log_warning "CSS responsive - V√©rification manuelle requise"
fi
TESTS_TOTAL=$((TESTS_TOTAL + 1))

# Test des d√©pendances externes
echo -e "\n${CYAN}üîó Tests D√©pendances Externes${NC}"
echo -e "${CYAN}===============================${NC}"

log_test "Bootstrap CDN"
if curl -s --max-time 5 "https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" >/dev/null 2>&1; then
    log_success "Bootstrap CDN accessible - R√âUSSI"
    TESTS_PASSED=$((TESTS_PASSED + 1))
else
    log_warning "Bootstrap CDN - V√©rification r√©seau requise"
fi
TESTS_TOTAL=$((TESTS_TOTAL + 1))

log_test "Font Awesome CDN"
if curl -s --max-time 5 "https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" >/dev/null 2>&1; then
    log_success "Font Awesome CDN accessible - R√âUSSI"
    TESTS_PASSED=$((TESTS_PASSED + 1))
else
    log_warning "Font Awesome CDN - V√©rification r√©seau requise"
fi
TESTS_TOTAL=$((TESTS_TOTAL + 1))

# Tests de performance
echo -e "\n${CYAN}‚ö° Tests Performance${NC}"
echo -e "${CYAN}===================${NC}"

log_test "Temps de r√©ponse page principale"
start_time=$(date +%s%N)
curl -s --max-time $TIMEOUT "$WEB_BASE" >/dev/null 2>&1
end_time=$(date +%s%N)
response_time=$(((end_time - start_time) / 1000000))

if [ $response_time -lt 1000 ]; then
    log_success "Temps de r√©ponse: ${response_time}ms - EXCELLENT"
    TESTS_PASSED=$((TESTS_PASSED + 1))
elif [ $response_time -lt 3000 ]; then
    log_success "Temps de r√©ponse: ${response_time}ms - BON"
    TESTS_PASSED=$((TESTS_PASSED + 1))
else
    log_warning "Temps de r√©ponse: ${response_time}ms - LENT"
fi
TESTS_TOTAL=$((TESTS_TOTAL + 1))

# Tests de s√©curit√© basiques
echo -e "\n${CYAN}üîí Tests S√©curit√© Basiques${NC}"
echo -e "${CYAN}===========================${NC}"

log_test "En-t√™tes CORS"
if curl -s -I "$API_BASE/status" | grep -q "Access-Control-Allow-Origin"; then
    log_success "En-t√™tes CORS pr√©sents - R√âUSSI"
    TESTS_PASSED=$((TESTS_PASSED + 1))
else
    log_warning "En-t√™tes CORS - √Ä v√©rifier"
fi
TESTS_TOTAL=$((TESTS_TOTAL + 1))

log_test "Protection contre l'injection"
if ! curl -s "$API_BASE/status?param=<script>alert('xss')</script>" | grep -q "<script>"; then
    log_success "Protection XSS basique - R√âUSSI"
    TESTS_PASSED=$((TESTS_PASSED + 1))
else
    log_error "Protection XSS basique - √âCHEC"
    TESTS_FAILED=$((TESTS_FAILED + 1))
fi
TESTS_TOTAL=$((TESTS_TOTAL + 1))

# R√©sum√© des tests
echo -e "\n${PURPLE}üìä R√âSUM√â DES TESTS${NC}"
echo -e "${PURPLE}===================${NC}"

echo -e "Tests ex√©cut√©s: ${CYAN}$TESTS_TOTAL${NC}"
echo -e "Tests r√©ussis:  ${GREEN}$TESTS_PASSED${NC}"
echo -e "Tests √©chou√©s:  ${RED}$TESTS_FAILED${NC}"

if [ $TESTS_FAILED -eq 0 ]; then
    echo -e "\n${GREEN}üéâ TOUS LES TESTS SONT PASS√âS !${NC}"
    echo -e "${GREEN}‚ú® L'interface web DoriaV2 est enti√®rement fonctionnelle${NC}"
    exit_code=0
elif [ $TESTS_PASSED -gt $TESTS_FAILED ]; then
    echo -e "\n${YELLOW}‚ö†Ô∏è  LA PLUPART DES TESTS SONT PASS√âS${NC}"
    echo -e "${YELLOW}üîß Quelques ajustements mineurs peuvent √™tre n√©cessaires${NC}"
    exit_code=0
else
    echo -e "\n${RED}‚ùå PLUSIEURS TESTS ONT √âCHOU√â${NC}"
    echo -e "${RED}üõ†Ô∏è  Une r√©vision de la configuration est recommand√©e${NC}"
    exit_code=1
fi

# Informations suppl√©mentaires
echo -e "\n${CYAN}üìã INFORMATIONS SUPPL√âMENTAIRES${NC}"
echo -e "${CYAN}================================${NC}"

echo -e "Interface web: ${YELLOW}$WEB_BASE${NC}"
echo -e "API REST:      ${YELLOW}$API_BASE${NC}"
echo -e "Documentation: ${YELLOW}$WEB_BASE/README.md${NC}"

# Tests de fonctionnalit√©s sp√©cifiques
echo -e "\n${CYAN}üéØ TESTS SP√âCIFIQUES DORIAE V2${NC}"
echo -e "${CYAN}===============================${NC}"

# Test configuration osmo
log_test "Configuration extension osmo compl√®te"
osmo_config=$(curl -s "$WEB_BASE" | grep -c "osmo\\|1000\\|osmoosmo\\|localhost:5060")
if [ $osmo_config -ge 4 ]; then
    log_success "Configuration osmo compl√®te - R√âUSSI"
    TESTS_PASSED=$((TESTS_PASSED + 1))
else
    log_error "Configuration osmo incompl√®te - √âCHEC"
    TESTS_FAILED=$((TESTS_FAILED + 1))
fi
TESTS_TOTAL=$((TESTS_TOTAL + 1))

# Test guide Linphone
log_test "Guide Linphone int√©gr√©"
if curl -s "$WEB_BASE" | grep -q "linphoneModal\\|Linphone\\|Configuration"; then
    log_success "Guide Linphone pr√©sent - R√âUSSI"
    TESTS_PASSED=$((TESTS_PASSED + 1))
else
    log_error "Guide Linphone manquant - √âCHEC"
    TESTS_FAILED=$((TESTS_FAILED + 1))
fi
TESTS_TOTAL=$((TESTS_TOTAL + 1))

echo -e "\n${PURPLE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
echo -e "${WHITE}          üß™ Tests Interface Web DoriaV2 Termin√©s          ${NC}"
echo -e "${PURPLE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}\n"

exit $exit_code
